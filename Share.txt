# Function to retrieve secrets from multiple Azure Key Vaults using Azure CLI
function Get-AKVSecrets {
    param (
        [string[]]$vaultNames # List of Azure Key Vault names
    )

    # Initialize an array to store secrets
    $allSecrets = @()

    foreach ($vault in $vaultNames) {
        Write-Host "Fetching secrets from Key Vault: $vault"

        try {
            # Get all secret names from the Key Vault
            $secrets = az keyvault secret list --vault-name $vault --query "[].name" -o json | ConvertFrom-Json

            foreach ($secretName in $secrets) {
                try {
                    # Retrieve the secret value
                    $secretValue = az keyvault secret show --vault-name $vault --name $secretName --query "value" -o tsv

                    # Create an object for better display
                    $secretObject = [PSCustomObject]@{
                        KeyVault = $vault
                        Name     = $secretName
                        Value    = $secretValue
                    }

                    # Store the secret in the array
                    $allSecrets += $secretObject
                }
                catch {
                    Write-Warning "Failed to retrieve secret value for: $secretName in $vault"
                }
            }
        }
        catch {
            Write-Warning "Failed to fetch secrets from Key Vault: $vault"
        }
    }

    # Display results
    return $allSecrets | Format-Table -AutoSize
}

# Example usage: Provide your Key Vault names in the array
$vaultNames = @("YourKeyVault1", "YourKeyVault2") # Replace with actual Key Vault names
Get-AKVSecrets -vaultNames $vaultNames
