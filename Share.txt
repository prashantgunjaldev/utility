import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClient.RequestHeadersUriSpec;
import org.springframework.web.reactive.function.client.WebClient.RequestHeadersSpec;
import org.springframework.web.reactive.function.client.WebClient.ResponseSpec;
import org.springframework.web.reactive.function.client.WebClientResponseException;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

import java.util.List;
import java.util.Map;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class ParallelHttpServiceTest {

    @Mock
    private WebClient.Builder webClientBuilder;

    @Mock
    private WebClient webClient;

    @Mock
    private RequestHeadersUriSpec<?> requestHeadersUriSpec;

    @Mock
    private RequestHeadersSpec<?> requestHeadersSpec;

    @Mock
    private ResponseSpec responseSpec;

    @InjectMocks
    private ParallelHttpService parallelHttpService;

    @BeforeEach
    void setUp() {
        when(webClientBuilder.build()).thenReturn(webClient);
        parallelHttpService.init();
    }

    @Test
    void fetchData_shouldReturnResponseOnSuccess() {
        String url = "http://example.com";
        List<String> cookies = List.of("cookie1", "cookie2");

        when(webClient.get()).thenReturn((WebClient.RequestHeadersUriSpec) requestHeadersUriSpec);
        when(requestHeadersUriSpec.uri(url)).thenReturn((RequestHeadersSpec) requestHeadersSpec);
        when(requestHeadersSpec.headers(any())).thenReturn(requestHeadersSpec);
        when(requestHeadersSpec.retrieve()).thenReturn(responseSpec);
        when(responseSpec.bodyToMono(String.class)).thenReturn(Mono.just("Success"));

        Mono<String> result = parallelHttpService.fetchData(url, Map.of("cookies", cookies));

        StepVerifier.create(result)
                .expectNext("Success")
                .verifyComplete();
    }

    @Test
    void fetchData_shouldReturnErrorMessageOnFailure() {
        String url = "http://example.com";
        List<String> cookies = List.of("cookie1", "cookie2");

        when(webClient.get()).thenReturn((WebClient.RequestHeadersUriSpec) requestHeadersUriSpec);
        when(requestHeadersUriSpec.uri(url)).thenReturn((RequestHeadersSpec) requestHeadersSpec);
        when(requestHeadersSpec.headers(any())).thenReturn(requestHeadersSpec);
        when(requestHeadersSpec.retrieve()).thenReturn(responseSpec);
        when(responseSpec.bodyToMono(String.class)).thenReturn(
                Mono.error(new WebClientResponseException(500, "Internal Server Error", null, null, null))
        );

        Mono<String> result = parallelHttpService.fetchData(url, Map.of("cookies", cookies));

        StepVerifier.create(result)
                .expectNextMatches(response -> response.startsWith("Error fetching"))
                .verifyComplete();
    }

    @Test
    void fetchDataInParallel_shouldFetchMultipleUrlsConcurrently() {
        List<String> urls = List.of("http://example.com/1", "http://example.com/2");
        Map<String, Object> jobContext = Map.of("cookies", List.of("cookie1"));

        when(webClient.get()).thenReturn((WebClient.RequestHeadersUriSpec) requestHeadersUriSpec);
        when(requestHeadersUriSpec.uri(any(String.class))).thenReturn((RequestHeadersSpec) requestHeadersSpec);
        when(requestHeadersSpec.headers(any())).thenReturn(requestHeadersSpec);
        when(requestHeadersSpec.retrieve()).thenReturn(responseSpec);
        when(responseSpec.bodyToMono(String.class)).thenReturn(Mono.just("Success"));

        List<String> result = parallelHttpService.fetchDataInParallel(urls, jobContext);

        verify(webClient, times(2)).get();
        verify(requestHeadersUriSpec, times(2)).uri(any(String.class));

        assert result.size() == 2;
        assert result.contains("Success");
    }
}
