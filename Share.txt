@RestController
public class FileProxyController {

    private final WebClient webClient;

    public FileProxyController() {
        this.webClient = WebClient.builder()
            .exchangeStrategies(ExchangeStrategies.builder()
                .codecs(configurer -> configurer.defaultCodecs()
                    .maxInMemorySize(1 * 1024 * 1024))  // 1MB buffer (only for small metadata if needed)
                .build())
            .build();
    }

    @GetMapping("/proxy-download")
    public Mono<ResponseEntity<Flux<DataBuffer>>> proxyDownload(@RequestParam String sasUrl) {
        Flux<DataBuffer> fileStream = webClient.get()
            .uri(URI.create(sasUrl))
            .accept(MediaType.APPLICATION_OCTET_STREAM)
            .retrieve()
            .bodyToFlux(DataBuffer.class);

        return Mono.just(
            ResponseEntity.ok()
                .contentType(MediaType.APPLICATION_OCTET_STREAM)
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"downloaded_file\"")
                .body(fileStream)
        );
    }
}
