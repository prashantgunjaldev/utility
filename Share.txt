import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.mock.web.ContentCachingRequestWrapper;
import org.springframework.mock.web.ContentCachingResponseWrapper;
import org.springframework.test.context.junit.jupiter.SpringExtension;

import org.junit.jupiter.api.extension.ExtendWith;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.Collections;
import java.util.Enumeration;

@ExtendWith(SpringExtension.class)
@SpringBootTest
class RequestResponseLoggingFilterTest {

    @MockBean
    private ApiLogService apiLogService;

    @MockBean
    private FilterChain filterChain;

    @MockBean
    private HttpServletRequest request;

    @MockBean
    private HttpServletResponse response;

    private RequestResponseLoggingFilter filter;
    private ContentCachingRequestWrapper requestWrapper;
    private ContentCachingResponseWrapper responseWrapper;

    @BeforeEach
    void setUp() {
        filter = new RequestResponseLoggingFilter(apiLogService);
        requestWrapper = new ContentCachingRequestWrapper(request);
        responseWrapper = new ContentCachingResponseWrapper(response);
    }

    @Test
    void testDoFilterInternal() throws ServletException, IOException {
        when(request.getMethod()).thenReturn("GET");
        when(request.getRequestURI()).thenReturn("/test");
        when(request.getRemoteAddr()).thenReturn("127.0.0.1");
        when(request.getHeaderNames()).thenReturn(Collections.enumeration(Collections.emptyList()));

        filter.doFilterInternal(request, response, filterChain);

        verify(filterChain).doFilter(any(), any());
        verify(apiLogService, atLeastOnce()).log(any());
    }

    @Test
    void testLogRequest() {
        Enumeration<String> headerNames = Collections.enumeration(Collections.singletonList("Content-Type"));
        when(request.getHeaderNames()).thenReturn(headerNames);
        when(request.getHeader("Content-Type")).thenReturn("application/json");

        byte[] body = "{\"key\":\"value\"}".getBytes(StandardCharsets.UTF_8);
        requestWrapper.getContentAsByteArray();

        filter.logRequest(requestWrapper, "test-uuid");

        verify(apiLogService).log(any());
    }

    @Test
    void testLogResponse() {
        when(response.getStatus()).thenReturn(200);
        byte[] responseBody = "{\"message\":\"success\"}".getBytes(StandardCharsets.UTF_8);
        responseWrapper.getContentAsByteArray();
        
        filter.logResponse(requestWrapper, responseWrapper, 500L, "test-uuid");

        verify(apiLogService).log(any());
    }

    @Test
    void testGetRequestHeaders() {
        when(request.getHeaderNames()).thenReturn(Collections.enumeration(Collections.singletonList("Authorization")));
        when(request.getHeader("Authorization")).thenReturn("Bearer token");

        String headers = filter.getRequestHeaders(requestWrapper);
        assertTrue(headers.contains("Authorization"));
    }

    @Test
    void testGetRequestBody() {
        byte[] body = "sample request".getBytes(StandardCharsets.UTF_8);
        requestWrapper.getContentAsByteArray();
        
        String requestBody = filter.getRequestBody(requestWrapper);
        assertNotNull(requestBody);
    }

    @Test
    void testGetResponseBody() {
        byte[] body = "sample response".getBytes(StandardCharsets.UTF_8);
        responseWrapper.getContentAsByteArray();
        
        String responseBody = filter.getResponseBody(responseWrapper);
        assertNotNull(responseBody);
    }
}
