# Function to retrieve secrets from multiple Azure Key Vaults and save to a JSON file
function Get-AKVSecrets {
    param (
        [string[]]$vaultNames,   # List of Azure Key Vault names
        [string]$outputFile = "secrets.json"  # Output file name
    )

    # Initialize an array to store secrets
    $allSecrets = @()

    foreach ($vault in $vaultNames) {
        Write-Host "Fetching secrets from Key Vault: $vault"

        try {
            # Get all secret names from the Key Vault
            $secrets = az keyvault secret list --vault-name $vault --query "[].name" -o json | ConvertFrom-Json

            foreach ($secretName in $secrets) {
                try {
                    # Retrieve the secret value
                    $secretValue = az keyvault secret show --vault-name $vault --name $secretName --query "value" -o tsv

                    # Create a JSON object
                    $secretObject = @{
                        createOrUpdate = "yes"
                        comments       = $null
                        name           = $secretName
                        value          = $secretValue
                    }

                    # Store the secret object in the array
                    $allSecrets += $secretObject
                }
                catch {
                    Write-Warning "Failed to retrieve secret value for: $secretName in $vault"
                }
            }
        }
        catch {
            Write-Warning "Failed to fetch secrets from Key Vault: $vault"
        }
    }

    # Convert to JSON and save to a file
    $jsonOutput = $allSecrets | ConvertTo-Json -Depth 3
    $jsonOutput | Out-File -Encoding utf8 $outputFile

    Write-Host "Secrets saved to $outputFile"
}

# Example usage: Provide your Key Vault names
$vaultNames = @("YourKeyVault1", "YourKeyVault2") # Replace with actual Key Vault names
Get-AKVSecrets -vaultNames $vaultNames -outputFile "dev-akv-secrets-v2.json"
